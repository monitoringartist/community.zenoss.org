<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>
        11.4 Creating a New Collector - Open Source Network Monitoring and Systems Management
        
        
    </title>

    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" /> 


<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Content-Language" content="en-US" />
<meta name="keywords" content=""/>
<!-- 11.4 Creating a New Collector -->
<meta property="og:image" content="servlet/JiveServlet/downloadImage/73-2574-13230/share-zenoss-logo.jpg" />

<link rel="search"
    href="../opensearch.xml"
    title="Zenoss Community"
    type="application/opensearchdescription+xml"/>


<link rel="shortcut icon" href="../themes/userbar-disabled/images/favicon.ico" />

    





    
      
      
     




    



    
    





    <link rel="stylesheet" href="../styles/jive-global.css" type="text/css" media="all" />
    <!-- <link rel="stylesheet" href="/styles/jive-icons-legacy.css" type="text/css" media="all" /> -->
    <link rel="stylesheet" href="../styles/jive-icons.css" type="text/css" media="all" />

    <link rel="stylesheet" href="../themes/userbar-disabled/styles/theme.css" type="text/css" media="all" />
    <link rel="stylesheet" href="../themes/userbar-disabled/styles/community.css" type="text/css" media="all" />
    <link rel="stylesheet" href="../themes/userbar-disabled/styles/sifr.css" type="text/css" media="all" />


    <!--[if IE 6]>
    <style type="text/css">
    /* hack for IE6's lack of alpha PNG support */
    * html #jive-wrapper .ie6png,
    * html #jive-wrapper #jive-global-header *.ie6png,
    * html #jive-wrapper #user-bar-wrapper *.ie6png,
    * html #jive-wrapper #jive-body *.ie6png,
    * html #jive-wrapper #jive-footer *.ie6png {
        background-image: expression(
        this.runtimeStyle.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(src=" +
        (this.tagName=='IMG' ? this.src : this.currentStyle.backgroundImage.split('\"')[1]) + ")",
        this.runtimeStyle.backgroundImage = "none",
        this.src = "/images/transparent.png"
        );
        }
    </style>

    <link rel="stylesheet" href="/styles/jive-icons-ie.css" type="text/css" media="all" />
    <![endif]-->





    
    

	<link rel="stylesheet" href="../4.5.6/styles/jive-content.css" type="text/css" media="all" />

        <link rel="alternate" type="application/rss+xml"
            title="11.4 Creating a New Collector Version History Feed"
            href="../community/feeds/document-history/DOC-10146" />

        <link rel="alternate" type="application/rss+xml"
            title="11.4 Creating a New Collector Comments Feed"
            href="../community/feeds/document-comments/DOC-10146" />

    
        




    <!-- BEGIN action bar, only for non-binary documents -->

    

    <!-- END action bar -->




    <style type="text/css">/* Rating bar on documents */
.jive-content .jive-content-header .jive-content-rating {margin-bottom: 3px;}
.j-rating { padding: 0 10px; }
.jive-content-avgrating {height: 53px;}
/* END Rating bar on documents */

/* Userbar */
#jive-userbar-right {right: 50px;}
/* END Userbar */

/* Download links page */
table.download-links-table {background-color: #ffffff; width: 100%;}
table.download-links-table tbody td { text-align: center; vertical-align: middle;}
table.download-links-table thead th {text-align: center;}
table.download-links-table td, table.download-links-table th {border: 1px solid #EEEEEE !important;}

/* Provides indentation for official doc ToC items */
div.toc dl dt {margin-left: 20px;}
div.toc dl dd dl dt {margin-left: 40px;}
div.toc dl dd dl dd dl dt {margin-left: 60px;}
div.toc dl dd dl dd dl dd dl dt {margin-left: 80px;}
div.toc dl dd dl dd dl dd dl dd dl dt {margin-left: 100px;}
/* END docs items */


/* Blog posts */
div.social-button-spacer {height: 10px;}

div#social-button-cont {
margin-right:10px; 
padding:5px; 
text-align: center; 
float: right;
}

div#comment-indicator {
    float: left;
    left: 12px;
    right: inherit;
    top: 55px;
}

div#comment-indicator div.jive-reply {margin-left: 0px;}

.jive-blog-post-subject {padding-bottom: 0px;}
/* END Blog posts */


/* Community download survey */
form#core-usage-survey label.aligned {float: left; width: 120px;}
form#core-usage-survey span.required_field {color: red;}
form#core-usage-survey label.survey-small-label {display:inline;}
form#core-usage-survey div.survey-checkbox-set {width:82%;}
form#core-usage-survey div.border {border:1px solid #ACACAC; padding:5px;}

form#core-usage-survey label.survey-resource_type {font-style:italic;}
form#core-usage-survey label {
color:#333333;
display:block;
font-size:12px;
font-weight:bold;
}
/* END Community download survey */

</style>
    <style type="text/css">/* custom-css-container */</style>


</head>
<body class="jive-body-home" ><div style="width:100%;background-color:white;float:left;position:fixed;z-index:3000;top:0;right:0;border-bottom:2px solid gray;"><div style="width:1006px;font-weight:bold;margin:12px auto 12px auto;font-size:18px;"><div style="float: left; margin: 0;">Archived community.zenoss.org | full text search <form style="display: inline;" target="_blank" action="https://github.com/monitoringartist/community.zenoss.org/search" method="get"><input type="text" name="q"><input type="submit" value="Search"></form> </div><div style="float: right;"><a href="https://www.monitoringartist.com" title="Maintained by Monitoring Artist - DevOps / Docker / Kubernetes / Zabbix / Zenoss / Monitoring"><img src="/community.zenoss.org/assests-monitoringartist/Monitoring-Artist-logo.png" /></a></div></div></div>


<a href="DOC-10146.html#jive-body" class="jive-skip-nav">Skip navigation</a>

    <div id="jive-compliance" class=""style="display:none">
        <span class="jive-icon-med "></span>
        
    </div>

    <div id="jive-wrapper" class="clearfix">

    <!-- Load search for guests -->

    <div id="jive-userbar-search">
    <form action="search.jspa" method="get" id="jive-userbar-search-form">
        <input type="hidden" name="peopleEnabled" value="true"/>

        <input type="hidden" name="userID"/>
        <input type="hidden" name="containerType"/>
        <input type="hidden" name="container"/>
        <input type="hidden" name="spotlight" value="false"/>
        <label for="jive-query"
               class="j-508-label">Search for:</label>
        <input type="text" id="jive-query" name="q" value="" accesskey="4" class="searchbar jive-userbar-search-field"
               autocomplete="off"/>
    </form>

    <div id="jive-spotlight-search-container"></div>
</div>

    <!-- END anon search -->

<!-- SKIP NAV FOR ACCESSIBILITY -->
<a href="DOC-10146.html#skipnav"></a>
<!-- END -->

<div id="header">

    <!-- START TOP NAVIGATION -->
    <div id="navcontainer">
        <table cellpadding="0" cellspacing="0" width="100%" border="0">
          <tr valign="bottom">
            <td rowspan="2">
                <a href="../index.html" title="Zenoss Open Source IT Management"><img src="../themes/userbar-disabled/images/zenoss-logo-reversed-web.png" style="width:254px; margin: 0 0px 25px;" alt="Zenoss Open Enterprise Management" /></a>
            </td>
            <td height="45" colspan="2">
                <div id="zenoss-panel">
                    <div style="width: 200px;" id="cpanel-lt"></div>
                    <ul id="subnav-rt" class="png_fix">
                        <li><a href="http://www.zenoss.com/" title="Zenoss.Inc Home" class="none">Zenoss, Inc.</a></li>
                        <!--<li><a href="/community/feedback" title="Feedback" class="none">Feedback</a></li>-->
                        <!--<li><a href="http://www.zenoss.com/support" title="Support" class="none">Support</a></li>-->
                    </ul>
                </div>
            </td>
          </tr>
          <tr valign="middle">
            <td colspan="2" height="80">
                <ul id="navlist">
                    <li><a href="community/documentation" title="DOCS" class="nav1"><span>DOCS</span></a></li>
                    <li><a href="community/forums" title="FORUMS" class="nav2"><span>FORUMS</span></a></li>        
                    <!--<li><a href="/community/zenpacks" title="ZENPACKS" class="nav3"><span>ZENPACKS</span></a></li>-->
                    <li><a href="http://wiki.zenoss.org/Category:ZenPacks" title="ZENPACKS" class="nav3"><span>ZENPACKS</span></a></li>        
                    <li><a href="community/partners" title="PARTNERS" class="nav4"><span>PARTNERS</span></a></li>      
                    <li><a href="community/about" title="ABOUT" class="nav4"><span>ABOUT</span></a></li>   
                    <li><a href="../blogs/zenossblog.html" title="BLOG" class="nav5"><span>BLOG</span></a></li>
                    <li><a href="community/testing" title="TESTING" class="nav5"><span>TESTING</span></a></li> 
                    <li><a href="community/developers" title="DEVELOPERS" class="nav6"><span>DEVELOPMENT</span></a></li>
                    <li><a href="../community/download.html" title="DOWNLOADS" class="nav7 png_fix"><span>DOWNLOAD</span></a></li>
                </ul>
            </td>
          </tr>
        </table>
    </div>
    <!-- END TOP NAV -->

</div>

<!-- START MID COL -->
<div id="middle">

    <!-- SKIPNAV ADDED FOR ACCESSIBILITY -->
    <a name="skipnav"></a>
    <!-- SKIPNAV END -->
        
      <!-- START CONTENT -->
      
        <!-- MAIN CONTENT START -->
        <!-- CHANGE CLASS ACCORDING TO SUB SECTION FOR PROPER TOP BANNER -->


        <div id="subcontent">




<!-- BEGIN user bar -->
<div id="user-bar-wrapper">
    <div id="jive-userbar">
<div id="jive-userbar-login">
    <form action="https://community.zenoss.org/cs_login"
          method="post" name="loginform" autocomplete="off">
        
        

        <span class="jive-userbar-login-welcome" id="jiveLoginWelcome">
            <span class="jive-userbar-login-guest">
            Welcome, Guest
            </span>

            <span class="jive-userbar-login-loginlink">
                <a href="DOC-10146.html#" onClick="jivetoggleLogin(); return false;">Login</a>
            </span>

            <span class="jive-userbar-login-new">
                <a href="../login!input.jspa%3FregisterOnly=true.html">Register</a>
            </span>
        </span>

        <span class="jive-userbar-login-form" id="jiveLoginForm" style="display: none;">

            <span class="jive-userbar-login-username">
                <label for="login-username">
Username:                </label>
                <a href="docs/forgot-username!input.jspa" title="I forgot my username ">(?)</a>
                <input type="text" name="username" size="20" maxlength="150" value="" tabindex="1"
                               id="login-username" />
            </span>

            <span class="jive-userbar-login-password">
                <label for="login-password">
Password:                </label>
                <a href="docs/emailPasswordToken!input.jspa" title="I forgot my password ">(?)</a>
                <input type="password" name="password" size="20" maxlength="150" value="" tabindex="2"
                               id="login-password" />
            </span>

            <span class="jive-userbar-login-auto">
                <input type="checkbox" name="autoLogin" id="login-auto" value="true" tabindex="3" />
                <label for="login-auto">Remember Me</label>
            </span>

            <span class="jive-userbar-login-submit">
                <input type="submit" name="login" value="Login" tabindex="4"
                       class="jive-login-button" />
                <input type="reset" name="doCancel" value="Cancel" tabindex="5"
                               class="jive-cancel-button" onclick="jivetoggleLogin();" />
            </span>
        </span>

    </form>
</div>        <div id="jive-userbar-right">

    <div id="jive-userbar-search">
    <form action="search.jspa" method="get" id="jive-userbar-search-form">
        <input type="hidden" name="peopleEnabled" value="true"/>

        <input type="hidden" name="userID"/>
        <input type="hidden" name="containerType"/>
        <input type="hidden" name="container"/>
        <input type="hidden" name="spotlight" value="false"/>
        <label for="jive-query"
               class="j-508-label">Search for:</label>
        <input type="text" id="jive-query" name="q" value="" accesskey="4" class="searchbar jive-userbar-search-field"
               autocomplete="off"/>
    </form>

    <div id="jive-spotlight-search-container"></div>
</div>

        </div>
    </div>

</div>
<!-- END user bar -->

            <div id="jive-body">

<!-- BEGIN breadcrumb -->
<div id="jive-breadcrumb">

    <span>
                <a href="../index.jspa.html">
            Zenoss Community</a> &gt; 
                <a href="community/documentation">
            Documentation</a> &gt; 
                <a href="community/documentation/official_documentation">
            Zenoss Core Product Documentation</a> &gt; 
                <a href="community/documentation/official_documentation/zenoss-dev-guide">
            Zenoss Developer's Guide</a> &gt; 
                <a href="community/documentation/official_documentation/zenoss-dev-guide/3.0v01">
            3.0v01</a> &gt; 

        <a class='jive-breadcrumb-last' href="community/documentation/official_documentation/zenoss-dev-guide/3.0v01?view=documents">Documents</a></span>
</div>
<!-- END breadcrumb -->

            

    <form id="documentRestoreForm" method="post" action='docs/DOC-10146/restore'>
        <input type="hidden" name="version" value="3" />
        <input type="hidden" name="jive.token.name" value="document.restore.DOC-10146"/>
        <input type="hidden" name="document.restore.DOC-10146" value="1394833709576-9SMUFE8JQNH2OAF1ZS0FFQP1BVYUATCX"/>
    </form>

    <form id="documentDeleteForm" method="post" action='docs/DOC-10146/delete'>
        <input type="hidden" name="jive.token.name" value="document.delete.DOC-10146"/>
        <input type="hidden" name="document.delete.DOC-10146" value="1394833709582-3RYH1PMRORD4YZ2ZNX3DDYQX3020BYVV"/>
    </form>

    <form id="documentPublishForm" method="post" action='doc-publish.jspa'>
        <input type="hidden" name="jive.token.name" value="document.publish.DOC-10146"/>
        <input type="hidden" name="document.publish.DOC-10146" value="1394833709588-IM15BJO1OWXT0Y0C965XIUFBVBF9128Q"/>
        <input type="hidden" name="document" value="DOC-10146" />
    </form>


    <!-- BEGIN header & intro  -->
    <div id="jive-body-intro">
        <div id="jive-body-intro-content">
            
            <a href="community/documentation/official_documentation/zenoss-dev-guide/3.0v01?view=documents"><span class="jive-icon-sml jive-icon-arrow-generic-up"></span>
                    Up to Documents in 3.0v01
            </a>

        </div>
    </div>
    <!-- END header & intro -->

    <!-- BEGIN main body -->
    <div id="jive-body-main">

        <!-- BEGIN main body column -->
        <div id="jive-body-maincol-container">

            <div id="jive-body-maincol">


                <div id="thread.watch.notify" class="jive-info-box" style="display:none"></div>

                <div id="content-featured-notify" class="jive-info-box" style="display:none"></div>








<!-- BEGIN document -->
<div class="jive-content clearfix">
    <div class="jive-content-header clearfix">
        <div class="jive-wiki-post-moderating jive-content-header-moderating">
            <span class="jive-icon-med jive-icon-moderation"></span>Currently Being Moderated
        </div>
        <div class="jive-content-title">
            <h2><span class="jive-icon-big jive-icon-document"></span>11.4 Creating a New Collector</h2>
        </div>
        <div class="jive-content-header-version">
            VERSION 3&nbsp;
                <a href="docs/DOC-10146/diff?secondVersionNumber=3" title="Click to view document history"><img class="jive-icon-sml jive-icon-search" src="../4.5.6/images/transparent.png" alt="Click to view document history" /></a>


        </div>
        <div class="jive-content-header-details">

Created on: Oct 28, 2010 1:58 PM by
<a href="../people/zenoss_api.html"
data-externalId=""
data-username="zenoss_api"
data-avatarId="-1"
id="jive-692632885093686122321"
onmouseover="var presence = null; quickuserprofile.getUserProfileTooltip( 6926, presence );"
onmouseout="quickuserprofile.cancelTooltip();"
class="jiveTT-hover-user jive-username-link"
>Zenoss API</a>            <span>-</span>
Last Modified:&nbsp;
Oct 28, 2010 2:05 PM
by <a href="../people/zenoss_api.html"
data-externalId=""
data-username="zenoss_api"
data-avatarId="-1"
id="jive-692632885093686703048"
onmouseover="var presence = null; quickuserprofile.getUserProfileTooltip( 6926, presence );"
onmouseout="quickuserprofile.cancelTooltip();"
class="jiveTT-hover-user jive-username-link"
>Zenoss API</a>        </div>

        <div class="jive-content-rating clearfix" data-guid="4VBVJNGV6NV8P4VLON3Z8Z1UNUEXM74S">

<script type='text/javascript'>
    $j(document).ready(function() {

        var i18n = {
            avgUserRatingTitlei18n : "Average User Rating",
            avgUserRatingLabeli18n : "Average User Rating",
            rateRatingLabel : "rating",
            myRatingLabel : "My Rating:",
            rateRatingsLabel : "ratings",
            ratingSavingText : "Saving...",
            rateSavedText : "Saved.",
            rateRatingSaved : "Rating Saved!",
            writeAReview : "Write a review",
            commentOnRating : "Comment on your rating",
            formSubmitPleaseWait:'Please Wait ...'
        };

        new jive.Rate(14, 2266, 102, 10146, 'doc', i18n, true, '4VBVJNGV6NV8P4VLON3Z8Z1UNUEXM74S');
    });

</script>

        </div>
    </div>

    <div class="jive-content-body">


<!-- [DocumentBodyStart:204f2864-9cb4-403d-b8f2-fff1f24bd19b] --><div class="jive-rendered-content"><div class="navheader"><table summary="Navigation header" width="100%"><tr><th align="center" colspan="3" style=";">4.&#160;Creating a New Collector</th></tr><tr><td align="left" style=";" width="20%"><a class="jive-link-external-small" href="zenoss-dev-guide/3.0-v01/ch11s03.html">Prev</a>&#160;</td><th align="center" style=";" width="60%">Chapter&#160;11.&#160;Add a Performance Daemon</th><td align="right" style=";" width="20%">&#160;<a class="jive-link-external-small" href="zenoss-dev-guide/3.0-v01/ch12.html">Next</a></td></tr></table><hr/></div><div class="section" title="4.&#160;Creating a New Collector"><div class="titlepage"><div><div><h2 class="title" style="clear: both;"><a class="jive-link-anchor-small" name="d0e5039">&#160;</a>4.&#160;Creating a New Collector</h2></div></div></div><p>For this section, we will contemplate a new collector that will collect ping performance data. We will want to create a new data source type with several built-in data points, such as Average Ping Time, and Fastest Ping Time.</p><div class="section" title="4.1.&#160;Constructor"><div class="titlepage"><div><div><h3 class="title"><a class="jive-link-anchor-small" name="extenddata_constructor">&#160;</a>4.1.&#160;Constructor</h3></div></div></div><p>The following example is a simple network ping-performance collector. It relies on the availability of fping to perform the actual ping test.</p><pre class="programlisting">class pingperf(RRDDaemon):
&#160;&#160; initialServices = RRDDaemon.initialServices + [
&#160;&#160;&#160;&#160;&#160;&#160; 'ZenPacks.zenoss.PingPerf.PingConfig'
&#160;&#160;&#160;&#160;&#160;&#160; ]
&#160;&#160; configCycleInterval = 20*60
&#160;&#160; pingCycleInterval = 5*60</pre><p>The class pingperf is derived from a base class that supports writing to RRD files. It is a also PBDaemon, which means that it will connect to ZenHub to fetch its configs and post events. PingConfig is the module/class that will be loaded in ZenHub to satisfy zenperf's configuration requests. We also configure reasonable default values for two cycles: the time between configuration refreshes and the time between ping tests.</p><pre class="programlisting">&#160;&#160; def __init__(self):
&#160;&#160;&#160;&#160;&#160;&#160; RRDDaemon.__init__(self, 'pingperf')
&#160;&#160;&#160;&#160;&#160;&#160; self.devices = {}&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # device id -&gt; ip address
&#160;&#160;&#160;&#160;&#160;&#160; self.running = False</pre><p>The constructor for this class calls the base's constructor, passing our name. We will need to hold the configuration between cycles, so we initialize an empty configuration. If the ping testing takes longer than one configuration cycle, we won't want to start a second test. We set a flag to note that we aren't running a ping test (yet).</p><p>When the base class is started, it attempts to connect to ZenHub and get remote references to the services is will use. Most collectors have two services: <code class="classname">EventService</code> and a collector-specific service that scans the model for configuration. Our service will be <code class="classname">PingConfig</code>. After the service reference are loaded, the base class calls a <code class="function">connected()</code> method.</p><pre class="programlisting">&#160;&#160; def connected(self):
&#160;&#160;&#160;&#160;&#160;&#160; def inner(driver):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.debug("fetching config")
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; yield self.fetchConfig()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; driver.next()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; driveLater(self.configCycleInterval, inner)
&#160;&#160;&#160;&#160;&#160;&#160; drive(inner).addCallbacks(self.pingDevices, self.errorStop)</pre><p>This method uses a technique to serialize a callback chain. See the <code class="filename">ZenUtils/Driver.py</code> for details on how this works. The effect is that the config is loaded with the <code class="function">fetchConfig()</code> method, and the inner function is called repeatedly after <span class="property">configCycleInterval</span> seconds.</p><p>Once the inner function completes the first time, it either calls <code class="function">pingDevices()</code> on success or <code class="function">errorStop()</code> on failure.</p></div><div class="section" title="4.2.&#160;Getting a List of Devices"><div class="titlepage"><div><div><h3 class="title"><a class="jive-link-anchor-small" name="d0e5089">&#160;</a>4.2.&#160;Getting a List of Devices</h3></div></div></div><p>When the collector connects, and requests its config from the Service, the service will walk the list of all the devices for that monitor, and extract out the ping data sources:</p><pre class="programlisting">def remote_getDevices(self):
&#160; config = []
&#160; monitor = self.dmd.Monitors.Performance._getOb(self.name)
&#160; for dev in self.monitor.devices():
&#160;&#160;&#160; for templ in dev.getRRDTemplates():
&#160;&#160;&#160;&#160;&#160; dataSources = templ.getRRDDataSources('Ping')
&#160;&#160;&#160;&#160;&#160; if dataSources:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; break
&#160; else:
&#160;&#160;&#160; continue
&#160; config.append(
&#160;&#160;&#160; (dev.id,&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # name of the device
&#160;&#160;&#160;&#160; dev.getManageIp(), # the IP to ping
&#160;&#160;&#160; dev.getThresholdInstances('Ping')
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # any thresholds on the ping
&#160;&#160;&#160;&#160; )
&#160;&#160; )</pre><p>To make this configuration load incremental, the Service can send just the name of the devices to load, and then the collector can use a different method to load the configuration of each device at a later time. For such a simple configuration, it may not be worth the extra complexity.</p><p>When this code is placed into a class that is a sub-class of HubService, it can be loaded by name, when the collector loads it services. PBDaemon will automatically connect you to this service, if the name of the service is provided in the class configuration.</p><p>The call to get this configuration in our new collector looks like this:</p><pre class="programlisting">&#160;&#160; d = self.getService('some.package.PingService').callRemote('getDevices')
&#160;&#160; d.addCallback(self.startCollection)</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title">Note</h3><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><code class="classname">PBDaemon</code> has already connected you to the service <code class="classname">some.package.PingService</code> class.</p></li><li class="listitem"><p><code class="function">getDevices</code> becomes <code class="function">remote_getDevices</code> in the hub.</p></li><li class="listitem"><p>The protocol for getting configurations is anything you like: you can control both sides of the communications.</p></li><li class="listitem"><p>Requests and responses are asynchronous and will involve callback objects.</p></li><li class="listitem"><p>The communications are heavily dependent on the Prospective Broker (PB) library in Twisted. Please refer to the <a class="jive-link-external-small" href="http://twistedmatrix.com/projects/core/documentation/howto/pb-intro.html" target="_top">Perspective Broker (PB) documentation</a> for how the calls to remote objects work.</p></li></ol></div></div><div class="section" title="4.2.1.&#160;Thresholds"><div class="titlepage"><div><div><h4 class="title"><a class="jive-link-anchor-small" name="d0e5134">&#160;</a>4.2.1.&#160;Thresholds</h4></div></div></div><p>As each collector reads updated performance data it will evaluate any thresholds associated with those updates. The classes representing those thresholds must be loaded before the thresholds may loaded evaluated. So, each collector asks ZenHub for the names of all of the thresholds that can be monitored and imports them for future use.</p><p>The management of Thresholds within the collector is complex. There exists a class (<code class="classname">Thresholds</code>) to manage the thresholds and transform performance updates into events.</p><div class="section" title="4.2.1.1.&#160;Complex Thresholds"><div class="titlepage"><div><div><h5 class="title"><a class="jive-link-anchor-small" name="d0e5144">&#160;</a>4.2.1.1.&#160;Complex Thresholds</h5></div></div></div><p>A complex threshold allows <span><a class="jive-link-anchor-small" name="product_name.32pp7">&#160;</a>Zenoss</span> to produce an event:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>When user time and system time is over 80%</p></li><li class="listitem"><p>When value A is 80% of value B</p></li><li class="listitem"><p>On a different RRD consolidation function from <code class="filename">AVERAGE</code></p></li><li class="listitem"><p>When a file system is X% full, and a critical event is Y% full</p></li></ul></div><div class="figure"><a class="jive-link-anchor-small" name="diagram_complex_thresholds">&#160;</a><p class="title"><strong>Figure&#160;11.2.&#160;Complex Thresholds</strong></p><div class="figure-contents"><div align="center" class="mediaobject"><table border="0" cellpadding="0" cellspacing="0" summary="manufactured viewport for HTML img" width="360"><tr><td align="center" style="border:0px solid black;" valign="middle"><a href="../servlet/JiveServlet/showImage/102-10146-3-6266/complex_thresholds.png"><img align="middle" alt="Complex Thresholds" class="jive-image" height="432" src="../servlet/JiveServlet/downloadImage/102-10146-3-6266/450-432/complex_thresholds.png" width="450"/></a></td></tr></table></div></div></div><br class="figure-break"/><p>Thresholds are not &ldquo;min/max value checkers&#8221; but &ldquo;transformers of values into events&#8221;. As new values come in, the Threshold will look at the value and determine if an event is warranted. Because of the inheritable template mechanism, we have two separate tasks for Thresholds. The first is to represent the configuration for a threshold within the template. A value like &ldquo;80&#8221; in the case of &ldquo;File System at 80% full&#8221; is part of the configuration. However, when applied to a context, such as file system &ldquo;C:\\&#8221; on device &ldquo;WINXYZ&#8221; the value becomes &ldquo;96000 blocks&#8221;. The value &ldquo;96000 blocks&#8221; needs to transfer from the <span><a class="jive-link-anchor-small" name="product_name.6dfbl">&#160;</a>Zenoss</span> object model, to the collector, so that values can be evaluated with the given context, without referring to the entire object model.</p><p>This leads us to separate thresholds into two components: one that hold the configuration and user intent, and another that can travel as part of the collector configuration to the collector. This &ldquo;Threshold with Context&#8221; object is then executed when new values for data points are collected. The first type of threshold (for configuration) is called <code class="classname">ThresholdClass</code>, and the second type, which evaluates a value with context is called a <code class="classname">ThresholdInstance</code>. The <span><a class="jive-link-anchor-small" name="product_name.au05n">&#160;</a>Zenoss</span> data model will load <code class="classname">ThresholdClass</code> classes from <span><a class="jive-link-anchor-small" name="product_name.3gekd">&#160;</a>Zenoss</span> and installed ZenPacks. These objects are responsible for creating the <code class="classname">ThresholdInstance</code> objects that are sent via the collector configuration for evaluation in the collector. Templates refer to derived versions of <code class="classname">ThresholdClass</code>, which when given a context, create <code class="classname">ThresholdInstance</code> objects.</p><p>To reduce the effort when writing a performance collector, support classes are used to hold <code class="classname">ThresholdInstances</code> and map updates to data points into threshold evaluation and event generation. The classes <code class="classname">MinMaxThreshold</code> and <code class="classname">MinMaxThresholdInstance</code> replaced the previous <code class="classname">Threshold</code> and flattening mechanism defined for data points and collectors in <span><a class="jive-link-anchor-small" name="product_name.58z7v">&#160;</a>Zenoss</span> version 2.0.X.</p><p>Presently, collectors are generally ignorant of context (device, or component), and almost certainly ignorant of <code class="classname">DataSources</code> and <code class="classname">DataPoints</code>. They are given the parameters necessary to fetch a value and store it into an RRD file. <code class="classname">ThresholdsInstances</code> wish to work on distinguished <code class="classname">DataSource</code>/<code class="classname">DataPoint</code> names within a context. So, to map from RRD files back to <code class="classname">Thresholds</code>, we use the RRD filename. When a collector updates a file, it notifies the <code class="classname">Thresholds</code> class (the utility class for all collectors to hold threshold information). This class maintains a mapping of file names to <code class="classname">Threshold</code> and <code class="classname">DataPoint</code>. Eventually, it might be worth translating the collectors so that they know about context and <code class="classname">DataPoint</code>.</p><div class="sidebar" title="Known Problems with Complex Thresholds"><p class="title"><strong>Known Problems with Complex Thresholds</strong></p><p>To send classes from Server to Client, the client has to expect and approve them. We will need to transfer the list of approved ThresholdInstance sub-classes before a client can load those thresholds. The collector will then have to approve and import these sub-classes at start-up.</p></div></div></div></div><div class="section" title="4.3.&#160;fetchConfig()"><div class="titlepage"><div><div><h3 class="title"><a class="jive-link-anchor-small" name="extenddata_fetchconfig">&#160;</a>4.3.&#160;<code class="function">fetchConfig()</code></h3></div></div></div><p>Let's look at <code class="function">fetchConfig()</code>:</p><pre class="programlisting">&#160;&#160; def fetchConfig(self):
&#160;&#160;&#160;&#160;&#160;&#160; 'Get configuration values from ZenHub'
&#160;&#160;&#160;&#160;&#160;&#160; def inner(driver):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; yield self.model().callRemote('getDefaultRRDCreateCommand')
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; createCommand = driver.next()

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; yield self.model().callRemote('propertyItems')
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.setPropertyItems(driver.next())

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.rrd = RRDUtil(createCommand, self.pingCycleInterval)

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; yield self.model().callRemote('getThresholdClasses')
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.remote_updateThresholdClasses(driver.next())

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; yield self.model().callRemote('getCollectorThresholds')
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.rrdStats.config(self.options.monitor,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.name,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; driver.next(),
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; createCommand)

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; devices = []
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if self.options.device:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; devices = [self.options.device]
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; yield self.model().callRemote('getDevices', devices)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; update = driver.next()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if not isinstance(update, dict):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.error("getDevices returned: %r" % update)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; else:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.devices = update
&#160;&#160;&#160;&#160;&#160;&#160; return drive(inner)</pre><p>Here the same drive/inner technique is used to serialize a bunch of asynchronous remote method calls. The base class provides a method called model() which returns a remote reference to the collector-specific configuration class. We call several remote methods, most of which are inherited from a base ZenHub service class.</p><p>We must get the default RRD create command. Then we copy the collector properties, which provides updated values for pingCycleInterval and configCycleInterval. In order to execute thresholds, we need to know the set of all threshold classes and get them imported. After the threshold classes are installed, we have to get the thresholds for this collector. These thresholds do not belong to the data points to be collected (ping response time), but for values like "total cycle time" that are based on the collectors performance.</p><p>Finally we call the remote method <code class="function">getDevices()</code> which returns a mapping of device id to IP address. We make allowances for the simple one-device invocation:</p><pre class="screen">pingperf -v 10 -d someDevice</pre></div><div class="section" title="4.4.&#160;Collector's ZenHub Service"><div class="titlepage"><div><div><h3 class="title"><a class="jive-link-anchor-small" name="extenddata_zenhub_service">&#160;</a>4.4.&#160;Collector's ZenHub Service</h3></div></div></div><p>Here's our ZenHub service:</p><pre class="programlisting">
from Products.ZenHub.services.PerformanceConfig import PerformanceConfig
class PingConfig(PerformanceConfig):
&#160;&#160;&#160; """
&#160;&#160;&#160; A very simple service for fetching device data
&#160;&#160;&#160; """

&#160;&#160;&#160; def getDeviceConfig(self, device):
&#160;&#160;&#160;&#160;&#160;&#160;&#160; return (device.id, device.getManageIp())

&#160;&#160;&#160; def sendDeviceConfig(self, listener, config):
&#160;&#160;&#160;&#160;&#160;&#160;&#160; listener.callRemote('updateDevice', config)

&#160;&#160;&#160; def remote_getDevices(self, devices):
&#160;&#160;&#160;&#160;&#160;&#160;&#160; result = {}
&#160;&#160;&#160;&#160;&#160;&#160;&#160; for d in self.config.getDevices():
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if not devices or d.id in devices:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; result[d.id] = d.getManageIp()
&#160;&#160;&#160;&#160;&#160;&#160;&#160; return result
</pre><p>Most of the implementation for this class is in the base class. The base class determines the devices affected when database changes occur. It then uses the methods getDeviceConfig and sendDeviceConfig to figure out how to send the changes to the collector.</p></div><div class="section" title="4.5.&#160;Miscellaneous Functions"><div class="titlepage"><div><div><h3 class="title"><a class="jive-link-anchor-small" name="extenddata_misc_functions">&#160;</a>4.5.&#160;Miscellaneous Functions</h3></div></div></div><p>Back to the collector, here are the methods that are called by ZenHub to update the collector with changes:</p><pre class="programlisting">&#160;&#160; def remote_deleteDevice(self, doomed):
&#160;&#160;&#160;&#160;&#160;&#160; log.debug("Async delete device %s" % doomed)
&#160;&#160;&#160;&#160;&#160;&#160; try:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; del self.devices[doomed]
&#160;&#160;&#160;&#160;&#160;&#160; except KeyError:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pass

&#160;&#160; def remote_updateDevice(self, cfg):
&#160;&#160;&#160;&#160;&#160;&#160; log.debug("Async config update for %s", cfg.name)
&#160;&#160;&#160;&#160;&#160;&#160; d, ip = cfg
&#160;&#160;&#160;&#160;&#160;&#160; self.devices[d] = ip</pre></div><div class="section" title="4.6.&#160;Collect the Performance Data"><div class="titlepage"><div><div><h3 class="title"><a class="jive-link-anchor-small" name="extenddata_collect_data">&#160;</a>4.6.&#160;Collect the Performance Data</h3></div></div></div><p>The only method left in our simple collector is to actually ping some devices, post the timings to a configuration file, send any resulting events, and send a heartbeat.</p><pre class="programlisting">&#160;&#160;&#160; def pingDevices(self, ignored=None):
&#160;&#160;&#160;&#160;&#160;&#160; def inner(driver):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; reactor.callLater(self.configCycleInterval, self.pingDevices)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if not self.options.cycle:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.stop()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if self.running:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.error("Ping is still running")
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.running = True

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.debug("Pinging %s..." % (" ".join(self.devices.keys())[:100]))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; start = time.time()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; revMap = dict([(ip, d) for d, ip in self.devices.items()])
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fd, fname = mkstemp()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fp = os.fdopen(fd, "w")
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.debug("Writing devices to tempfile %s." % fname)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fp.write('\n'.join(revMap.keys()) + '\n')
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fp.close()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; from twisted.internet.utils import getProcessOutput
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fping = os.path.join(os.path.dirname(__file__), "fping.sh")
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.debug("starting %s" % fping)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; yield getProcessOutput(fping, (fname,))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.debug("fping returned: %s" % driver.next())
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; for line in driver.next().split('\n'):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if not line: continue
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; match = parseLine.match(line)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if not match:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.debug("%s does not match expected output" % line)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; continue
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ip = match.group(IP)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ms = float(match.group(MS))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if not revMap.has_key(ip):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; continue
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; device = revMap.pop(ip)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; path = 'Devices/%s/ping_time' % device
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ms = self.rrd.save(path, ms, 'GAUGE')
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; for ev in self.thresholds.check(path, time.time(), ms):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.sendThresholdEvent(**ev)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; os.unlink(fname)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.heartbeat()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cycle = self.pingCycleInterval
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.rrdStats.gauge('devices', cycle, len(self.devices))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.rrdStats.gauge('down', cycle, len(revMap))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.rrdStats.gauge('cycleTime', cycle, time.time() - start)

&#160;&#160;&#160;&#160;&#160;&#160; d = drive(inner)
&#160;&#160;&#160;&#160;&#160;&#160; def clearRunning(arg):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.running = False
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if isinstance(arg, Failure):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.error("Error pinging devices: %s" % (arg,))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return arg
&#160;&#160;&#160;&#160;&#160;&#160; d.addBoth(clearRunning)
&#160;&#160;&#160;&#160;&#160;&#160; return d</pre><p>This is a long method, so let's take it in parts. Let's take everything outside of the <code class="function">inner()</code> function:</p><pre class="programlisting">def inner():
&#160;&#160;&#160; # ....

&#160;&#160;&#160;&#160;&#160;&#160; d = drive(inner)
&#160;&#160;&#160;&#160;&#160;&#160; def clearRunning(arg):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.running = False
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if isinstance(arg, Failure):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; msg = "Error occurred in pingperf collection: %s" % (arg.value,)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.sendEvent(WARNING_EVENT, summary=msg)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return arg
&#160;&#160;&#160;&#160;&#160;&#160; self.running = True
&#160;&#160;&#160;&#160;&#160;&#160; d.addBoth(clearRunning)
&#160;&#160;&#160;&#160;&#160;&#160; return d</pre><p>Again we are using the same drive/inner approach to serialize asynchronous calls. We also want to track the fact that we are running the inner method so that we can detect cases where our collection cycle is taking too long. The <code class="function">clearRunning()</code> function is added to the callback chain to ensure that the running flag is reset however the inner function completes. It was also a convenient place to report on any errors. Here's the definition of <code class="constant">WARNING_EVENT</code> to remove any mystery about its value:</p><p>The following is a constant definition used to send an event if the collector has an error:</p><pre class="programlisting">WARNING_EVENT = dict(eventClass=Status_Ping,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; component="ping",
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; device=socket.getfqdn(),
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; severity=Warning)
</pre><p>The inner function does all the work:</p><pre class="programlisting">&#160;&#160;&#160;&#160;&#160;&#160; def inner(driver):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; reactor.callLater(self.configCycleInterval, self.pingDevices)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if not self.options.cycle:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.stop()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if self.running:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.error("Ping is still running")
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return </pre><p>This bit of code controls the ping cycle. By starting the timer call chain immediately we are ensured to repeat the call in the future even if an error occurs or the collection takes too long.</p><pre class="programlisting">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.debug("Pinging %s..." % (" ".join(self.devices.keys())[:100]))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; start = time.time()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; revMap = dict([(ip, d) for d, ip in self.devices.items()])
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fd, fname = mkstemp()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fp = os.fdopen(fd, "w")
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.debug("Writing devices to tempfile %s." % fname)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fp.write('\n'.join(revMap.keys()) + '\n')
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fp.close()</pre><p>Our implementation for pinging all the devices is farmed out to an external process (fping). So we write a config file for fping (a list of IP addresses) into a temporary file. Next, we run fping and collect the results:</p><pre class="programlisting">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; from twisted.internet.utils import getProcessOutput
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fping = os.path.join(os.path.dirname(__file__), "fping.sh")
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.debug("starting %s" % fping)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; yield getProcessOutput(fping, (fname,))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.debug("fping returned: %s" % driver.next())</pre><p>The next loop parses each line of output using a regular expression:</p><pre class="programlisting">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.debug("fping returned: %s" % driver.next())
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; for line in driver.next().split('\n'):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if not line: continue
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; match = parseLine.match(line)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if not match:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; log.debug("%s does not match expected output" % line)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; continue
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ip = match.group(IP)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ms = float(match.group(MS))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if not revMap.has_key(ip):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; continue</pre><p>When a match is found, we determine the device from the IP address and post the value to an RRD file:</p><pre class="programlisting">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; device = revMap.pop(ip)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; path = 'Devices/%s/ping_time' % device
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ms = self.rrd.save(path, ms, 'GAUGE')</pre><p>We use the resulting value (which may have been averaged in with other data from the RRD file) to check thresholds:</p><pre class="programlisting">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; for ev in self.thresholds.check(path, time.time(), ms):
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.sendThresholdEvent(**ev)</pre><p>Finally, we remove the temporary file, send a heartbeat, and report statistics on the total number of devices, the devices that did not report, and the total time to process the device list.</p><pre class="programlisting">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; os.unlink(fname)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.heartbeat()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; cycle = self.pingCycleInterval
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.rrdStats.gauge('devices', cycle, len(self.devices))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.rrdStats.gauge('down', cycle, len(revMap))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.rrdStats.gauge('cycleTime', cycle, time.time() - start)</pre></div></div><div class="navfooter"><hr/><table summary="Navigation footer" width="100%"><tr><td align="left" style=";" width="40%"><a class="jive-link-external-small" href="zenoss-dev-guide/3.0-v01/ch11s03.html">Prev</a>&#160;</td><td align="center" style=";" width="20%"><a class="jive-link-external-small" href="zenoss-dev-guide/3.0-v01/ch11.html">Up</a></td><td align="right" style=";" width="40%">&#160;<a class="jive-link-external-small" href="zenoss-dev-guide/3.0-v01/ch12.html">Next</a></td></tr><tr><td align="left" style=";" valign="top" width="40%">3.&#160;Performance Collection&#160;</td><td align="center" style=";" width="20%"><a class="jive-link-external-small" href="zenoss-dev-guide/3.0-v01/index.html">Home</a></td><td align="right" style=";" valign="top" width="40%">&#160;Chapter&#160;12.&#160;Adding a Device Type</td></tr></table></div></div><!-- [DocumentBodyEnd:204f2864-9cb4-403d-b8f2-fff1f24bd19b] -->

<!-- BEGIN attachments -->
<!-- END attachments -->
    </div>
    <div class="jive-content-footer clearfix">


    <!-- BEGIN content details -->
        <span class="jive-content-footer-item jive-content-footer-acclaim">

<div id="acclaim-container-102-10146-" class="acclaim-container">
    <div id="jive-acclaim-like-container-102-10146-" data-uniqueKey="102-10146-" data-ratingType="like" data-hasVoted="false" data-likes="0" class="acclaim-like-container">
         <span class="jive-icon-sml jive-icon-like"></span>Like
         (<a href="DOC-10146.html#" id="jive-acclaim-likedlink-102-10146-"  class=" jive-acclaim-likedlink">0</a>)
    </div>
</div>        </span>

     
        <span class="jive-content-footer-item">
            3400&nbsp;Views
        </span>

        



    <!-- BEGIN view/add/edit tags -->
    <span class="jive-content-footer-item jive-content-footer-tags">
    </span>
    <!-- END view/add/edit tags -->
<!-- END content -->

    </div>
</div>
<!-- END document -->





    
    <script>
    </script>






    <link rel="stylesheet" type="text/css" href="../4.5.6/styles/tiny_mce3/plugins/inlinepopups/skins/clearlooks2/window.css" />




    




        <a name="comments"></a>

        <!-- BEGIN tabs -->
        <div class="jive-body-tabbar">

                <span id="jive-comments-tab" class="jive-body-tab jive-body-tabcurrent">
                    <strong class="font-color-normal">
                        Comments (<span id="jive-comments-count">0</span>)
                    </strong>
                </span>

        </div>
        <!-- END tabs -->

            <div class="jive-box clearfix" id="jive-comments" ></div>

        <div style="display:none;" id="jive-comment-post-block">
            <form method="post" action="javascript:void(0);" name="jive-comment-post-form">

                <p class="jive-error-text" id="jive-comment-error" style="display:none"></p>

                    <div class="jive-comment-post-anonymous">
                        <div>
                            <input id="comment-author" name="commentGuestName" />
                            <label for="comment-author">Name</label>
                        </div>
                        <div>
                            <input id="comment-email" name="commentGuestEmail"  />
                            <label for="comment-email">Email Address</label>
                        </div>
                        <div>
                            <input id="comment-url" name="commentGuestUrl" />
                            <label for="comment-url">Website Address</label>
                        </div>
                    </div>

                <div>
                    <textarea name="commentBody" id="wysiwygtext" rows="10" class="jive-comment-textarea"></textarea>
                </div>

                <div style="display:none;" id="jive-blog-comment-preview" class="jive-blog-comment-preview"></div>


                <div class="jive-form-buttons">
                    <input type="submit" name="post" value="Add Comment" />
                    <input type="button" name="cancel" value="Cancel" />
                </div>

            </form>
        </div>

        <div style="display:none;"  id="jive-comment-edit-block">
            <form method="post" action="javascript:void(0);" name="jive-comment-edit-form">
                <p class="jive-error-text" id="jive-comment-error" style="display:none"></p>
                <div class="jive-comment-post-anonymous">
                    <div>
                        <input name="name" value="" />
                        <label for="name">Name
                            <span>(required)</span></label>
                    </div>
                    <div>
                        <input name="email" value="" />
                        <label for="email">Email Address
                            <span>(required, will not be published)</span></label>
                    </div>
                    <div>
                        <input name="url" value=""/>
                        <label for="url">Website Address</label>
                    </div>
                </div>
                <div>
                    <textarea name="commentBody" id="wysiwygtext" rows="10" class="jive-comment-textarea"><%= commentBody %></textarea>
                </div>

                <div style="display:none;" id="jive-blog-comment-preview" class="jive-blog-comment-preview"></div>

                <div class="jive-form-buttons">
                    <input type="button" name="post" value="Save" />
                    <input type="button" name="cancel" value="Cancel" />
                </div>

            </form>
        </div>




            </div>
        </div>
        <!-- END main body column -->


        <!-- BEGIN sidebar column -->
        <div id="jive-body-sidebarcol-container">

            <div id="jive-body-sidebarcol">


<div id="jive-action-sidebar" class="jive-sidebar jive-box jive-sidebar-actions jive-box-actions">


    <div class="jive-box-header">
        <h4 id="jive-action-sidebar-tab-header_document-actions-tab">Actions</h4>
    </div>
    <div id="jive-action-sidebar-body" class="jive-sidebar-body jive-sidebar-body-actions jive-box-body">

        <div id="jive-action-sidebar-tab-_document-actions-tab"
             class="jive-action-sidebar-tab-first"
 >



            <ul id="jive-action-sidebar-tab-list_document-actions-tab" class=" jive-icon-list">
















                <li id="jive-link-thread-print" style=""
                        ><a href="DOC-10146%3Fdecorator=print.html"
rel="nofollow"
onclick=""
title="">
<span class="jive-icon-med jive-icon-print-preview"></span>
View print preview
</a></li>



            </ul>
        </div> <!-- /#jive-action-sidebar-tab-_id -->
    </div>

</div>




    <!-- BEGIN sidebar box 'More Like This' -->

    <div class="jive-box jive-sidebar">
        <div class="jive-box-header jive-sidebar-header">
            <h4>More Like This</h4>
        </div>
        <div class="jive-box-body jive-sidebar-body jive-sidebar-body-morelikethis">
            <ul class="jive-icon-list" id="jive-more-like-this-102-10146">
                <li><span>Retrieving data ...</span></li>
            </ul>
        </div>
    </div>

    <!-- END sidebar box 'More Like This' -->

    
    

        
        
        
        
        

<!-- BEGIN sidebar box 'User Content' -->
<div class="jive-box jive-sidebar">
    <div class="jive-box-header jive-sidebar-header">
        <h4>More by Zenoss API</h4>
    </div>
    <div class="jive-box-body jive-sidebar-body jive-sidebar-body-usercontent">
        <ul class="jive-icon-list">
                    <li>
                        <a href="DOC-10092.html"
                        ><span class="jive-icon-med jive-icon-document"></span>1.1 Overview</a>
                    </li>
                    <li>
                        <a href="DOC-10123.html"
                        ><span class="jive-icon-med jive-icon-document"></span>9.2 One-to-Many (1:N) Relationships</a>
                    </li>
                    <li>
                        <a href="DOC-10088.html"
                        ><span class="jive-icon-med jive-icon-document"></span>3.3 ZenPack Structure and Contents</a>
                    </li>
                    <li>
                        <a href="DOC-10099.html"
                        ><span class="jive-icon-med jive-icon-document"></span>13.6 Other Customizations</a>
                    </li>
                    <li>
                        <a href="DOC-10109.html"
                        ><span class="jive-icon-med jive-icon-document"></span>9.1 Add a ZenModel Relationship</a>
                    </li>
        </ul>
        <div class="jive-sidebar-viewall">
            <a href="../people/zenoss_api.html" class="font-color-meta j-link-viewall"><strong>View Zenoss API's profile</strong></a>
        </div>
    </div>
</div>
<!-- END sidebar box 'User Content' -->


            </div>

        </div>
        <!-- END sidebar column -->


    </div>



        </div>

<div class="clear"></div>
        </div>
        <!-- MAIN CONTENT END -->
     <!-- END CONTENT -->

</div>
<!-- END MIDDLE CONTENT -->

<!-- START FOOTER -->
<div id="footer">
 <table cellpadding="0" cellspacing="0" border="0">
   <tr valign="top">
      <td rowspan="2" style="padding-left:10px;padding-right:10px;">
        <ul id="socialmedia">
        <li><a href="http://feeds.feedburner.com/ZenossBlog" class="rss" target="_blank"><span>rss</span></a></li>
           <li><a href="http://twitter.com/zenoss" class="twitter" target="_blank"><span>twitter</span></a></li>
           <li><a href="http://slashdot.org/bookmark.pl" class="slashdot" target="_blank"><span>slashdot</span></a></li>
           <li><a href="http://www.reddit.com/" class="reddit" target="_blank"><span>reddit</span></a></li>
           <li><a href="http://delicious.com/save" class="del" target="_blank"><span>delicious</span></a></li>
           <li><a href="http://technorati.com/" class="tech" target="_blank"><span>technorati</span></a></li>
       </ul> 
     </td>
     <td rowspan="2" style="padding-left:10px;padding-right:10px;">
        <a href="http://twitter.com/zenoss" title="Follow us on Twitter">Follow Us On Twitter &raquo;</a>
       <ul id="twitter_update_list"> </ul>
     </td>
     <td rowspan="2" style="padding-right:10px;">
        <a href="../blogs/zenossblog.html" title="Latest from the Zenoss blog">Latest from the Zenoss Blog &raquo;</a>
       <script language="JavaScript" src="http://feed2js.org//feed2js.php?src=http%3A%2F%2Ffeeds.feedburner.com%2FZenossBlog%3Fformat%3Dxml&amp;num=3&amp;desc=85&amp;targ=y" type="text/javascript"></script>
       <noscript><a href="http://feed2js.org//feed2js.php?src=http%3A%2F%2Ffeeds.feedburner.com%2FZenossBlog%3Fformat%3Dxml&amp;num=3&amp;desc=85&amp;targ=y&amp;html=y">View RSS feed</a></noscript>
     </td>
     <td rowspan="2" valign="middle" style="padding-right:20px;">
        <img src="../themes/userbar-disabled/images/tableborder.png" alt="" />
     </td>
     <td>
        Community
       <ul class="sitemap">
        <li><a href="../index.jspa.html" title="Home">Home</a></li>
           <li><a href="community/documentation" title="Documentation">Documentation</a></li>
           <li><a href="community/developers" title="Code">Code</a></li> 
           <li><a href="community/zenpacks" title="ZenPacks">ZenPacks</a></li> 
           <li><a href="community/forums" title="Discussion">Discussion</a></li> 
           <li><a href="community/partners" title="Get Involved">Get Involved</a></li> 
           <li><a href="../people.1.html" title="Membership">Membership</a></li>
       </ul>
     </td>
     <td>
        Products
       <ul class="sitemap">
                        <li><a href="http://www.zenoss.com/solution/overview" title="Overview">Overview</a></li>
                        <li><a href="http://www.zenoss.com/solution/virtualization-monitoring" title="Virtualization Monitoring">Virtualization Monitoring</a></li>
                        <li><a href="http://www.zenoss.com/solution/cloud-monitoring" title="Cloud Monitoring">Cloud Monitoring</a></li>
                        <li><a href="http://www.zenoss.com/solution/cisco-ucs-management" title="Cisco UCS Management">Cisco UCS Management</a></li>
                        <li><a href="http://www.zenoss.com/solution/server-monitoring" title="Server Monitoring">Server Monitoring</a></li>
                        <li><a href="http://www.zenoss.com/solution/network" title="Network Monitoring">Network Monitoring</a></li>
       </ul>
     </td>
     <td>
        Services
       <ul class="sitemap">
                        <li><a href="http://www.zenoss.com/support/index" title="Support Overview">Overview</a></li>
                        <li><a href="http://www.zenoss.com/support/consulting" title="Consulting">Consulting</a></li>
                        <li><a href="http://www.zenoss.com/support/customer-support" title="Support">Customer Support</a></li>
                        <li><a href="http://www.zenoss.com/support/training" title="Training">Training</a></li>        
       </ul>
       Resources
       <ul class="sitemap">
                        <li><a href="http://www.zenoss.com/resources/demo" title="Resources">Resource Center</a></li>
       </ul>
     </td>
     <td>
       Customers
       <ul class="sitemap">
                        <li><a href="http://www.zenoss.com/customers/index" title="Customers Overview">Overview</a></li>
                        <li><a href="http://www.zenoss.com/customers/case-studies/case-studies" title="Case Studies">Case Studies</a></li>
                        <li><a href="http://www.zenoss.com/customers/by-industry" title="Case Studies">Customers by Industry</a></li>
                        <li><a href="http://www.zenoss.com/customers/industries/index" title="Industries"><span>Industries</span></a></li>
       </ul>


       Partners
       <ul class="sitemap">
            <li><a href="http://www.zenoss.com/partners/open-source-network-management-solutions" title="Current Partners">Current Partners</a></li>
            <li><a href="http://www.zenoss.com/partners/contact" title="Become a Partner">Become a Partner</a></li>
       </ul>
     </td>
     <td style="padding-right:0px;">
        About Us
       <ul class="sitemap">
        <li><a href="http://www.zenoss.com/about/index" title="Overview">Overview</a></li> 
           <li><a href="http://www.zenoss.com/about/awards" title="Awards">Awards</a></li> 
           <li><a href="http://www.zenoss.com/about/team" title="Team">Team</a></li> 
           <li><a href="http://www.zenoss.com/about/news" title="News">News</a></li> 
           <li><a href="http://www.zenoss.com/about/news/events" title="Events">Events</a></li> 
           <li><a href="http://www.zenoss.com/about/jobs" title="Careers">Careers</a></li> 
           <li><a href="http://www.zenoss.com/about/contact" title="Contact">Contact</a></li>
       </ul>
     </td>
   </tr>
   <tr valign="middle">
     <td align="right">
        <a href="http://sourceforge.net/projects/zenoss" target="_blank" title="SourceForge"><img width="120" height="30" alt="Get Zenoss Core - Enterprise IT Monitoring at SourceForge.net. Fast, secure and Free Open Source software downloads" src="http://sflogo.sourceforge.net/sflogo.php?group_id=163126&amp;type=11"></a>
     </td>
     <td align="right">
        <a href="../index.html" title="Monitored by Zenoss"><img src="../themes/userbar-disabled/images/logo-monitoredby_ZEN.png" alt="Monitored By Zenoss" /></a>
     </td>
      <td colspan="3" align="right" >
        <a href="../index.html" title="Zenoss Home"><img src="../themes/userbar-disabled/images/new-logo-zenoss-footer_ZEN.gif" /></a>
       <div id="copyright" class="right">Copyright &copy; 2005-2011 Zenoss, Inc.</div>
     </td>
   </tr>
   <tr valign="top">
     <td colspan="9" align="right">&nbsp;</td>
   </tr>
 </table>
</div>
<!-- END FOOTER -->

 <!-- BEGIN SCRIPTS --> 

   <!-- END -->

    <!-- TOP NAV DROP DOWN NAVIGATION - IE6 -->
   <!-- END DROP DOWN -->       

   <!-- TWITTER SCRIPTS -->

<!-- END GOOGLE ANALYTICS CODE -->

<!-- Pardot tracking code, async version -->
<!-- END Pardot tracking code, async version -->




<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-73372470-1','auto');ga('send','pageview');</script></body>
</html>

